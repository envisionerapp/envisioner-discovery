generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  firstName   String?
  lastName    String?
  password    String
  mfaEnabled  Boolean  @default(false)
  mfaSecret   String?
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  conversations Conversation[]
  chatMessages ChatMessage[]
  campaignAssignments StreamerCampaign[]

  @@map("discovery_users")
}

model Streamer {
  id            String    @id @default(cuid())
  platform      Platform
  username      String
  displayName   String
  profileUrl    String
  avatarUrl     String?
  followers     Int       @default(0)
  currentViewers Int?
  highestViewers Int?
  lastStreamed  DateTime?
  isLive        Boolean   @default(false)
  currentGame   String?
  topGames      String[]
  tags          String[]
  region        Region
  language      String    @default("en")
  socialLinks   Json      @default("[]")
  usesCamera    Boolean   @default(false)
  isVtuber      Boolean   @default(false)
  fraudCheck    FraudStatus @default(CLEAN)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastScrapedAt DateTime?
  lastSeenLive  DateTime? @map("last_seen_live")

  // Sync Optimization
  syncTier       SyncTier  @default(STANDARD) @map("sync_tier")
  lastSyncedBy   String?   @map("last_synced_by")  // 'discovery' or 'redtrack-api'
  socialSyncedAt DateTime? @map("social_synced_at") // Last ScrapeCreators sync

  // Social Metrics (Instagram/TikTok/FB/X/LinkedIn)
  totalViews    BigInt    @default(0) @map("total_views")
  totalLikes    BigInt    @default(0) @map("total_likes")
  totalComments BigInt    @default(0) @map("total_comments")
  totalShares   BigInt    @default(0) @map("total_shares")

  // Streaming Metrics (Twitch/Kick/YouTube)
  durationMinutes Int     @default(0) @map("duration_minutes")
  avgViewers      Int     @default(0) @map("avg_viewers")
  minutesWatched  BigInt  @default(0) @map("minutes_watched")

  // Calculated Fields
  engagementRate  Float   @default(0) @map("engagement_rate")

  // Content Category
  primaryCategory String? @map("primary_category")

  // Inferred Demographics (from cross-platform unification)
  inferredCountry       String?  @map("inferred_country")       // ISO code inferred from linked profiles
  inferredCountrySource String?  @map("inferred_country_source") // Platform that provided the country (e.g., "YOUTUBE", "TWITCH")
  unifiedTags           String[] @default([]) @map("unified_tags") // Merged tags from all linked platforms

  // iGaming Intelligence Fields
  igamingIntelligence   Json? @map("igaming_intelligence")
  igamingScore          Int   @default(0) @map("igaming_score")
  audiencePsychology    Json? @map("audience_psychology")
  brandSafetyScore      Int   @default(0) @map("brand_safety_score")
  gamblingCompatibility Boolean @default(false) @map("gambling_compatibility")
  lastIntelligenceUpdate DateTime? @map("last_intelligence_update")
  riskAssessment        Json? @map("risk_assessment")
  conversionPotential   Json? @map("conversion_potential")

  // Enriched Web Data Fields
  profileDescription    String? @map("profile_description") @db.Text
  bannerText            String? @map("banner_text") @db.Text
  panelTexts            String[] @map("panel_texts")
  panelImages           Json? @map("panel_images")
  aboutSection          String? @map("about_section") @db.Text
  externalLinks         Json? @map("external_links")
  streamTitles          Json? @map("stream_titles")
  chatKeywords          String[] @map("chat_keywords")
  communityPosts        Json? @map("community_posts")
  contentAnalysis       Json? @map("content_analysis")
  webPresence           Json? @map("web_presence")
  lastEnrichmentUpdate  DateTime? @map("last_enrichment_update")

  // Performance feedback from Envisioner (historical data)
  historicalCpa         Float? @map("historical_cpa")
  historicalConversions Int    @default(0) @map("historical_conversions")
  historicalCampaigns   Int    @default(0) @map("historical_campaigns")
  avgRoi                Float? @map("avg_roi")
  lastPerformanceSync   DateTime? @map("last_performance_sync")

  // Relations
  campaignAssignments StreamerCampaign[]
  chatMessages ChatMessage[] @relation("ChatMessageStreamers")
  campaignPerformances CampaignPerformance[]
  favorites DiscoveryFavorite[]
  discarded DiscoveryDiscarded[]
  discoveryNotes DiscoveryNote[]
  viewerPolls DiscoveryViewerPoll[]

  @@unique([platform, username])
  @@index([isLive])
  @@index([platform])
  @@index([region])
  @@index([currentViewers(sort: Desc)])
  @@index([highestViewers(sort: Desc)])
  @@index([followers(sort: Desc)])
  @@index([displayName])
  @@index([isLive, platform])
  @@index([isLive, currentViewers(sort: Desc)])
  @@index([avgViewers(sort: Desc)])
  @@index([totalViews(sort: Desc)])
  @@index([engagementRate(sort: Desc)])
  @@index([primaryCategory])
  @@index([lastScrapedAt(sort: Desc)])
  @@index([inferredCountry])
  @@index([syncTier])
  @@index([socialSyncedAt(sort: Asc)])
  @@map("discovery_creators")
}

model CachedStats {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("discovery_cached_stats")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  rules       Json     @default("[]")
  isActive    Boolean  @default(true)
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assignedStreamers StreamerCampaign[]

  @@map("discovery_campaigns")
}

model StreamerCampaign {
  id         String   @id @default(cuid())
  streamerId String
  campaignId String
  assignedBy String
  assignedAt DateTime @default(now())
  notes      String?
  status     CampaignStatus @default(ACTIVE)

  // Relations
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [assignedBy], references: [id])

  @@unique([streamerId, campaignId])
  @@map("discovery_streamer_campaigns")
}

model Conversation {
  id          String   @id @default(cuid())
  userId      String
  title       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("discovery_conversations")
}

model ChatMessage {
  id               String    @id @default(cuid())
  userId           String
  conversationId   String
  message          String
  response         String?
  streamersReturned String[]
  timestamp        DateTime  @default(now())
  processingTime   Int?

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  streamers    Streamer[]   @relation("ChatMessageStreamers")

  @@map("discovery_chat_messages")
}

model ScrapingLog {
  id             String    @id @default(cuid())
  platform       Platform
  success        Boolean
  recordsFound   Int       @default(0)
  recordsUpdated Int       @default(0)
  errors         String[]  @default([])
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  duration       Int?

  @@map("discovery_scraping_logs")
}

model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique
  value String
  updatedAt DateTime @updatedAt

  @@map("discovery_system_config")
}

// Link table for tracking creators assigned to Envisioner campaigns
model DiscoveryAssignment {
  id                  String    @id @default(cuid())
  discoveryCreatorId  String    @map("discovery_creator_id")
  envisionerInfluencerId String? @map("envisioner_influencer_id")
  assignedAt          DateTime  @default(now()) @map("assigned_at")
  envisionerCampaignId String?  @map("envisioner_campaign_id")

  // Performance sync from Envisioner
  lastPerformanceSync DateTime? @map("last_performance_sync")
  totalConversions    Int       @default(0) @map("total_conversions")
  totalSpent          Float     @default(0) @map("total_spent")
  avgCpa              Float?    @map("avg_cpa")

  @@map("discovery_assignments")
}

// Search history for analytics
model DiscoverySearch {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  filters      Json
  resultsCount Int      @map("results_count")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("discovery_searches")
}

// Favorites for bookmarking creators
model DiscoveryFavorite {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  streamerId String   @map("streamer_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@unique([userId, streamerId])
  @@index([userId])
  @@index([streamerId])
  @@map("discovery_favorites")
}

// Discarded creators (hidden from general search)
model DiscoveryDiscarded {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  streamerId String   @map("streamer_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@unique([userId, streamerId])
  @@index([userId])
  @@index([streamerId])
  @@map("discovery_discarded")
}

// Notes for creators (per user)
model DiscoveryNote {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  streamerId String   @map("streamer_id")
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@unique([userId, streamerId])
  @@index([userId])
  @@index([streamerId])
  @@map("discovery_notes")
}

// Viewer polls for calculating avg_viewers
model DiscoveryViewerPoll {
  id          String   @id @default(cuid())
  streamerId  String   @map("streamer_id")
  viewerCount Int      @map("viewer_count")
  polledAt    DateTime @default(now()) @map("polled_at")

  // Relations
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@index([streamerId, polledAt(sort: Desc)])
  @@map("discovery_viewer_polls")
}

enum Platform {
  TWITCH
  YOUTUBE
  KICK
  FACEBOOK
  TIKTOK
  INSTAGRAM
  X
  LINKEDIN
}

enum StreamerTag {
  GAMING
  IRL
  MUSIC
  ART
  COOKING
  FITNESS
  EDUCATION
  TECHNOLOGY
  FASHION
  TRAVEL
  SPORTS
  COMEDY
  VARIETY
  RPG
  FPS
  STRATEGY
  SIMULATION
  HORROR
  ADVENTURE
  CASINO
  SLOTS
  BETTING
  POKER
  BLACKJACK
  ROULETTE
  GAMBLING
  IGAMING
}

enum Region {
  // Latin America
  MEXICO
  COLOMBIA
  ARGENTINA
  CHILE
  PERU
  VENEZUELA
  ECUADOR
  BOLIVIA
  PARAGUAY
  URUGUAY
  COSTA_RICA
  PANAMA
  GUATEMALA
  EL_SALVADOR
  HONDURAS
  NICARAGUA
  DOMINICAN_REPUBLIC
  PUERTO_RICO
  BRAZIL

  // North America
  USA
  CANADA

  // Europe
  UK
  SPAIN
  GERMANY
  FRANCE
  ITALY
  PORTUGAL
  NETHERLANDS
  SWEDEN
  NORWAY
  DENMARK
  FINLAND
  POLAND
  RUSSIA

  // Asia
  JAPAN
  KOREA
  CHINA
  INDIA
  INDONESIA
  PHILIPPINES
  THAILAND
  VIETNAM
  MALAYSIA
  SINGAPORE

  // Oceania
  AUSTRALIA
  NEW_ZEALAND

  // Other
  WORLDWIDE
  OTHER
}

enum FraudStatus {
  CLEAN
  SUSPICIOUS
  FLAGGED
  PENDING_REVIEW
}

enum CampaignStatus {
  ACTIVE
  PENDING
  COMPLETED
  CANCELLED
}

enum SyncStatus {
  PENDING
  COMPLETED
  FAILED
}

enum SyncTier {
  HOT      // Currently live OR >10k avg viewers - sync every 5 min
  ACTIVE   // Posted in last 7 days OR >1k followers - sync every 30 min
  STANDARD // Posted in last 30 days - sync every 2 hours
  COLD     // No activity 30+ days - sync every 24 hours
}

// Unified Influencer Profile - One row per person, all platforms linked
model Influencer {
  id            String   @id @default(cuid())

  // === UNIFIED IDENTITY ===
  displayName   String                          // Primary display name
  country       String?                         // ISO country code (US, MX, BR, etc.)
  countrySource String? @map("country_source")  // Platform that provided country (YOUTUBE, TWITCH, etc.)
  language      String?                         // Primary language
  primaryCategory String? @map("primary_category") // Gaming, IRL, Music, etc.
  tags          String[] @default([])           // Merged tags from all linked platforms

  // === TWITCH ===
  twitchId          String?   @unique @map("twitch_id")
  twitchUsername    String?   @map("twitch_username")
  twitchDisplayName String?   @map("twitch_display_name")
  twitchFollowers   Int?      @map("twitch_followers")
  twitchAvatar      String?   @map("twitch_avatar")
  twitchUrl         String?   @map("twitch_url")
  twitchVerified    Boolean   @default(false) @map("twitch_verified")

  // === YOUTUBE ===
  youtubeId          String?   @unique @map("youtube_id")
  youtubeUsername    String?   @map("youtube_username")
  youtubeDisplayName String?   @map("youtube_display_name")
  youtubeFollowers   Int?      @map("youtube_followers")
  youtubeAvatar      String?   @map("youtube_avatar")
  youtubeUrl         String?   @map("youtube_url")
  youtubeVerified    Boolean   @default(false) @map("youtube_verified")

  // === KICK ===
  kickId          String?   @unique @map("kick_id")
  kickUsername    String?   @map("kick_username")
  kickDisplayName String?   @map("kick_display_name")
  kickFollowers   Int?      @map("kick_followers")
  kickAvatar      String?   @map("kick_avatar")
  kickUrl         String?   @map("kick_url")
  kickVerified    Boolean   @default(false) @map("kick_verified")

  // === TIKTOK ===
  tiktokId          String?   @unique @map("tiktok_id")
  tiktokUsername    String?   @map("tiktok_username")
  tiktokDisplayName String?   @map("tiktok_display_name")
  tiktokFollowers   Int?      @map("tiktok_followers")
  tiktokLikes       BigInt?   @map("tiktok_likes")
  tiktokVideos      Int?      @map("tiktok_videos")
  tiktokAvatar      String?   @map("tiktok_avatar")
  tiktokUrl         String?   @map("tiktok_url")
  tiktokVerified    Boolean   @default(false) @map("tiktok_verified")

  // === INSTAGRAM ===
  instagramId          String?   @unique @map("instagram_id")
  instagramUsername    String?   @map("instagram_username")
  instagramDisplayName String?   @map("instagram_display_name")
  instagramFollowers   Int?      @map("instagram_followers")
  instagramLikes       BigInt?   @map("instagram_likes")
  instagramPosts       Int?      @map("instagram_posts")
  instagramAvatar      String?   @map("instagram_avatar")
  instagramUrl         String?   @map("instagram_url")
  instagramVerified    Boolean   @default(false) @map("instagram_verified")

  // === X (TWITTER) ===
  xId          String?   @unique @map("x_id")
  xUsername    String?   @map("x_username")
  xDisplayName String?   @map("x_display_name")
  xFollowers   Int?      @map("x_followers")
  xAvatar      String?   @map("x_avatar")
  xUrl         String?   @map("x_url")
  xVerified    Boolean   @default(false) @map("x_verified")

  // === FACEBOOK ===
  facebookId          String?   @unique @map("facebook_id")
  facebookUsername    String?   @map("facebook_username")
  facebookDisplayName String?   @map("facebook_display_name")
  facebookFollowers   Int?      @map("facebook_followers")
  facebookAvatar      String?   @map("facebook_avatar")
  facebookUrl         String?   @map("facebook_url")
  facebookVerified    Boolean   @default(false) @map("facebook_verified")

  // === LINKEDIN ===
  linkedinId          String?   @unique @map("linkedin_id")
  linkedinUsername    String?   @map("linkedin_username")
  linkedinDisplayName String?   @map("linkedin_display_name")
  linkedinFollowers   Int?      @map("linkedin_followers")
  linkedinAvatar      String?   @map("linkedin_avatar")
  linkedinUrl         String?   @map("linkedin_url")
  linkedinVerified    Boolean   @default(false) @map("linkedin_verified")

  // === AGGREGATED METRICS ===
  totalReach        BigInt    @default(0) @map("total_reach")  // Sum of all followers
  totalLikes        BigInt    @default(0) @map("total_likes")  // Sum of all likes
  totalViews        BigInt    @default(0) @map("total_views")  // Sum of all views
  platformCount     Int       @default(0) @map("platform_count") // Number of platforms linked
  avgEngagementRate Float?    @map("avg_engagement_rate")

  // === GDPR COMPLIANCE ===
  dataSource        String    @default("public_api") @map("data_source") // public_api, user_submitted, manual
  deletionRequested Boolean   @default(false) @map("deletion_requested")
  deletionRequestedAt DateTime? @map("deletion_requested_at")
  lastVerifiedAt    DateTime? @map("last_verified_at")  // When data was last confirmed public

  // === METADATA ===
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // === LINK TO ORIGINAL STREAMER RECORDS ===
  sourceStreamerIds String[] @default([]) @map("source_streamer_ids") // Original streamer IDs used to build this

  @@index([country])
  @@index([totalReach(sort: Desc)])
  @@index([platformCount(sort: Desc)])
  @@index([twitchUsername])
  @@index([youtubeUsername])
  @@index([tiktokUsername])
  @@index([instagramUsername])
  @@map("discovery_influencers")
}

// Queue for social platform sync (ScrapeCreators API)
model SocialSyncQueue {
  id              String     @id @default(cuid())
  platform        Platform
  username        String
  priority        Int        @default(50) // Higher = processed first
  status          SyncStatus @default(PENDING)
  sourceStreamerId String?   @map("source_streamer_id") // The Twitch/Kick/YT streamer this was extracted from
  retryCount      Int        @default(0) @map("retry_count")
  errorMessage    String?    @map("error_message")
  createdAt       DateTime   @default(now()) @map("created_at")
  processedAt     DateTime?  @map("processed_at")

  @@unique([platform, username])
  @@index([platform, status])
  @@index([priority(sort: Desc)])
  @@map("discovery_social_sync_queue")
}

model IGamingCampaign {
  id                String    @id @default(cuid())
  name              String
  campaignType      String    @map("campaign_type")
  targetDemographics Json?    @map("target_demographics")
  budget            Int?
  expectedRoi       Float?    @map("expected_roi")
  startDate         DateTime? @map("start_date")
  endDate           DateTime? @map("end_date")
  status            String    @default("draft")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  performances CampaignPerformance[]

  @@map("discovery_igaming_campaigns")
}

model CampaignPerformance {
  id                   String    @id @default(cuid())
  campaignId           String    @map("campaign_id")
  streamerId           String    @map("streamer_id")
  predictedPerformance Json?     @map("predicted_performance")
  actualPerformance    Json?     @map("actual_performance")
  performanceScore     Int       @default(0) @map("performance_score")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  campaign IGamingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  streamer Streamer         @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@map("discovery_campaign_performance")
}

// API Usage Tracking - Credit monitoring across projects
model ApiUsage {
  id          String   @id @default(cuid())
  provider    String   // 'scrapecreators', 'youtube', 'twitch', 'kick'
  endpoint    String?  // Specific endpoint called
  creditsUsed Int      @default(1) @map("credits_used")
  project     String   // 'discovery', 'redtrack-api'
  success     Boolean  @default(true)
  errorCode   String?  @map("error_code")
  recordedAt  DateTime @default(now()) @map("recorded_at")

  @@index([provider, recordedAt(sort: Desc)])
  @@index([project, recordedAt(sort: Desc)])
  @@index([recordedAt(sort: Desc)])
  @@map("api_usage")
}
